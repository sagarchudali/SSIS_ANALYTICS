@model SSISAnalyticsDashboard.Models.DashboardViewModel
@{
    ViewData["Title"] = "SSIS Analytics Dashboard";
}

<style>
    .spinner-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }
    
    .card.loading {
        opacity: 0.7;
    }
    
    #refreshBtn.loading .bi-arrow-clockwise {
        animation: spin 1s linear infinite;
    }
    
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .pulse {
        animation: pulse-animation 1s ease-in-out;
    }
    
    @@keyframes pulse-animation {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
</style>

<div class="container-fluid">
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error!</strong> @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Header -->
        }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i>
            <strong>Success!</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h1 class="display-4 mb-2">SSIS Analytics Dashboard</h1>
            <p class="text-muted mb-0">
                <i class="bi bi-server"></i> Monitor your SQL Server Integration Services executions 
                <span id="autoRefreshStatus" class="badge bg-success ms-2">Auto-refresh: ON</span>
            </p>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" onclick="manualRefresh()" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-outline-success" onclick="exportToCSV()" id="exportBtn">
                    <i class="bi bi-download"></i> Export Data
                </button>
                <a href="@Url.Action("Index", "ServerConfig")" class="btn btn-outline-secondary">
                    <i class="bi bi-gear"></i> Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel"></i> Filters
                        <button class="btn btn-sm btn-link float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="filterCollapse">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label">Business Unit</label>
                                <select class="form-select" id="businessUnitFilter">
                                    <option value="" selected>All Units</option>
                                    <option value="ClientRepo">ClientRepo (CR_)</option>
                                    <option value="ChartNav">ChartNav (CN_)</option>
                                    <option value="EDS">EDS (EDS_)</option>
                                    <option value="HIM">HIM (HIM_)</option>
                                    <option value="Uncategorized">Uncategorized</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="dateRangeFilter">
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="1">Today</option>
                                    <option value="90">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status Filter</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="Succeeded">Succeeded</option>
                                    <option value="Failed">Failed</option>
                                    <option value="Running">Running</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Search Packages</label>
                                <input type="text" class="form-control" id="packageSearch" placeholder="Search by package name...">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="bi bi-check2-circle"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Currently Running Packages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-play-circle"></i> Currently Running Packages
                        <span class="badge bg-light text-dark ms-2" id="currentExecutionCount">@Model.CurrentExecutions.Count</span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.CurrentExecutions != null && Model.CurrentExecutions.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="currentExecutionsTable">
                                <thead>
                                    <tr>
                                        <th>Execution ID</th>
                                        <th>Package Name</th>
                                        <th>Status</th>
                                        <th>Started</th>
                                        <th>Duration</th>
                                        <th>Executed By</th>
                                        <th>Alert</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var exec in Model.CurrentExecutions)
                                    {
                                        <tr>
                                            <td><strong>@exec.ExecutionId</strong></td>
                                            <td>@exec.PackageName</td>
                                            <td><span class="badge bg-primary">@exec.StatusDescription</span></td>
                                            <td>@exec.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>
                                                @{
                                                    var duration = TimeSpan.FromSeconds(exec.DurationSeconds);
                                                    <span class="@(exec.IsLongRunning ? "text-danger fw-bold" : "")">
                                                        @string.Format("{0:D2}:{1:D2}:{2:D2}", duration.Hours, duration.Minutes, duration.Seconds)
                                                    </span>
                                                }
                                            </td>
                                            <td>@exec.ExecutedBy</td>
                                            <td>
                                                @if (exec.IsLongRunning)
                                                {
                                                    <span class="badge bg-warning" title="Running longer than 30 minutes">
                                                        <i class="bi bi-exclamation-triangle"></i> Long Running
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> No packages currently executing
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Package Performance Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-speedometer2"></i> Package Performance (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    @if (Model.PackagePerformanceStats != null && Model.PackagePerformanceStats.Any())
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Package</th>
                                        <th>Executions</th>
                                        <th>Success Rate</th>
                                        <th>Avg Duration</th>
                                        <th>Last Run</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var perf in Model.PackagePerformanceStats.Take(10))
                                    {
                                        <tr>
                                            <td class="text-truncate" style="max-width: 200px;" title="@perf.PackageName">@perf.PackageName</td>
                                            <td><span class="badge bg-secondary">@perf.TotalExecutions</span></td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar @(perf.SuccessRate >= 90 ? "bg-success" : perf.SuccessRate >= 70 ? "bg-warning" : "bg-danger")" 
                                                         role="progressbar" 
                                                         style="width: @perf.SuccessRate%">
                                                        @perf.SuccessRate%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                @{
                                                    var avgDuration = TimeSpan.FromSeconds(perf.AvgDurationSeconds);
                                                    <span>@string.Format("{0:D2}:{1:D2}:{2:D2}", avgDuration.Hours, avgDuration.Minutes, avgDuration.Seconds)</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-@(perf.LastExecutionStatus == "Success" ? "success" : "danger")">
                                                    @perf.LastExecutionStatus
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No performance data available</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-bug"></i> Top Failure Patterns (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    @if (Model.FailurePatterns != null && Model.FailurePatterns.Any())
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Package</th>
                                        <th>Failures</th>
                                        <th>Failure Rate</th>
                                        <th>Last Failure</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var pattern in Model.FailurePatterns.Take(10))
                                    {
                                        <tr>
                                            <td class="text-truncate" style="max-width: 200px;" title="@pattern.PackageName">
                                                <strong>@pattern.PackageName</strong>
                                            </td>
                                            <td><span class="badge bg-danger">@pattern.FailureCount</span></td>
                                            <td>
                                                <span class="text-danger fw-bold">@pattern.FailureRate%</span>
                                            </td>
                                            <td>
                                                <small>@(pattern.LastFailureTime?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" class="bg-light">
                                                <small class="text-muted text-truncate d-block" style="max-width: 100%;" title="@pattern.MostCommonError">
                                                    <i class="bi bi-exclamation-circle"></i> @pattern.MostCommonError
                                                </small>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle"></i> No failures detected in the last 30 days!
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Timeline -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history"></i> Execution Timeline (Last 24 Hours)</h5>
                </div>
                <div class="card-body">
                    @if (Model.ExecutionTimeline != null && Model.ExecutionTimeline.Any())
                    {
                        <div class="timeline" style="max-height: 500px; overflow-y: auto;">
                            @foreach (var item in Model.ExecutionTimeline)
                            {
                                <div class="timeline-item border-start border-3 border-@item.StatusColor ps-3 pb-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <span class="badge bg-@item.StatusColor">@item.Status</span>
                                                <strong>@item.PackageName</strong>
                                            </h6>
                                            <p class="mb-1 text-muted">
                                                <small>
                                                    <i class="bi bi-clock"></i> Started: @item.StartTime.ToString("yyyy-MM-dd HH:mm:ss")
                                                    @if (item.EndTime.HasValue)
                                                    {
                                                        <span>| Ended: @item.EndTime.Value.ToString("HH:mm:ss")</span>
                                                    }
                                                </small>
                                            </p>
                                            <p class="mb-0">
                                                <span class="badge bg-secondary">Duration: @item.DurationMinutes min</span>
                                                <span class="badge bg-light text-dark">ID: @item.ExecutionId</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No executions in the last 24 hours</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <!-- Metrics Cards -->
    <div class="row g-4 mb-4" id="metricsCards">
        <div class="col-md-3">
            <div class="card border-primary position-relative">
                <div class="card-body">
                    <div class="spinner-overlay d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    </div>
                    <h6 class="card-subtitle mb-2 text-muted">Total Executions</h6>
                    <h2 class="card-title display-4">@Model.Metrics.TotalExecutions</h2>
                    <p class="card-text text-muted">Last 30 days</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success position-relative">
                <div class="card-body">
                    <div class="spinner-overlay d-none">
                        <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    </div>
                    <h6 class="card-subtitle mb-2 text-muted">Successful</h6>
                    <h2 class="card-title display-4 text-success">@Model.Metrics.SuccessfulExecutions</h2>
                    <p class="card-text text-muted">@Model.Metrics.SuccessRate% success rate</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger position-relative">
                <div class="card-body">
                    <div class="spinner-overlay d-none">
                        <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                    </div>
                    <h6 class="card-subtitle mb-2 text-muted">Failed</h6>
                    <h2 class="card-title display-4 text-danger">@Model.Metrics.FailedExecutions</h2>
                    <p class="card-text text-muted">Requires attention</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning position-relative">
                <div class="card-body">
                    <div class="spinner-overlay d-none">
                        <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                    </div>
                    <h6 class="card-subtitle mb-2 text-muted">Avg Duration</h6>
                    <h2 class="card-title display-4 text-warning">@Model.Metrics.AvgDuration s</h2>
                    <p class="card-text text-muted">Average execution time</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Success Rate Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="successRateChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Execution Trends (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Executions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card position-relative" id="recentExecutionsCard">
                <div class="card-header">
                    <h5>Recent Executions</h5>
                </div>
                <div class="spinner-overlay d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentExecutionsTable">
                            <thead>
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Package</th>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Start Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RecentExecutions != null && Model.RecentExecutions.Any())
                                {
                                    @foreach (var execution in Model.RecentExecutions)
                                    {
                                        <tr>
                                            <td>@execution.ExecutionId</td>
                                            <td>@execution.PackageName</td>
                                            <td>@execution.ProjectName</td>
                                            <td>
                                                @if (execution.Status == "Succeeded")
                                                {
                                                    <span class="badge bg-success">@execution.Status</span>
                                                }
                                                else if (execution.Status == "Failed")
                                                {
                                                    <span class="badge bg-danger">@execution.Status</span>
                                                }
                                                else if (execution.Status == "Running")
                                                {
                                                    <span class="badge bg-primary">@execution.Status</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">@execution.Status</span>
                                                }
                                            </td>
                                            <td>@execution.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>@FormatDuration(execution.Duration)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> No recent executions found in the last 30 days.
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Last 10 Executed Packages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card position-relative" id="lastExecutedPackagesCard">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Last 10 Executed Packages</h5>
                </div>
                <div class="spinner-overlay d-none">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="lastExecutedPackagesTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Package Name</th>
                                    <th>Folder</th>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.LastExecutedPackages != null && Model.LastExecutedPackages.Any())
                                {
                                    @foreach (var package in Model.LastExecutedPackages)
                                    {
                                        <tr>
                                            <td><span class="badge bg-secondary">@package.ExecutionId</span></td>
                                            <td><strong>@package.PackageName</strong></td>
                                            <td>@package.FolderName</td>
                                            <td>@package.ProjectName</td>
                                            <td>
                                                @if (package.Status == "Succeeded")
                                            {
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> @package.Status
                                                </span>
                                            }
                                            else if (package.Status == "Failed")
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-x-circle"></i> @package.Status
                                                </span>
                                            }
                                            else if (package.Status == "Running")
                                            {
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-arrow-clockwise"></i> @package.Status
                                                </span>
                                            }
                                            else if (package.Status == "Pending")
                                            {
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-hourglass"></i> @package.Status
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@package.Status</span>
                                            }
                                        </td>
                                        <td>@package.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>
                                            @if (package.EndTime.HasValue)
                                            {
                                                @package.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss")
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (package.Duration > 0)
                                            {
                                                @FormatDuration(package.Duration)
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> No package executions found.
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Errors -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Errors</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentErrorsTable">
                            <thead>
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Package</th>
                                    <th>Error Time</th>
                                    <th>Error Code</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RecentErrors != null && Model.RecentErrors.Any())
                                {
                                    @foreach (var error in Model.RecentErrors)
                                    {
                                        <tr>
                                            <td>@error.ExecutionId</td>
                                            <td>@error.PackageName</td>
                                            <td>@error.ErrorTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>@error.ErrorCode</td>
                                            <td class="text-truncate" style="max-width: 400px;">@error.ErrorDescription</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="alert alert-success mb-0">
                                                <i class="bi bi-check-circle"></i> No errors found in the last 30 days. Great job!
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string FormatDuration(int seconds)
    {
        var hours = seconds / 3600;
        var minutes = (seconds % 3600) / 60;
        var secs = seconds % 60;

        if (hours > 0)
            return $"{hours}h {minutes}m {secs}s";
        else if (minutes > 0)
            return $"{minutes}m {secs}s";
        else
            return $"{secs}s";
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global chart instances
        let successChart;
        let trendsChart;
        let autoRefreshInterval;
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // Initialize charts
        function initCharts() {
            // Success Rate Pie Chart
            const successCtx = document.getElementById('successRateChart').getContext('2d');
            successChart = new Chart(successCtx, {
                type: 'pie',
                data: {
                    labels: ['Successful', 'Failed'],
                    datasets: [{
                        data: [@Model.Metrics.SuccessfulExecutions, @Model.Metrics.FailedExecutions],
                        backgroundColor: ['#198754', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Trends Line Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.Trends.Select(t => $"'{t.Date}'")))],
                    datasets: [{
                        label: 'Successful',
                        data: [@string.Join(",", Model.Trends.Select(t => t.Success))],
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    }, {
                        label: 'Failed',
                        data: [@string.Join(",", Model.Trends.Select(t => t.Failed))],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Show loading indicators
        function showLoading() {
            document.getElementById('refreshBtn').classList.add('loading');
            document.querySelectorAll('.spinner-overlay').forEach(spinner => {
                spinner.classList.remove('d-none');
            });
            document.querySelectorAll('#metricsCards .card').forEach(card => {
                card.classList.add('loading');
            });
        }

        // Hide loading indicators
        function hideLoading() {
            document.getElementById('refreshBtn').classList.remove('loading');
            document.querySelectorAll('.spinner-overlay').forEach(spinner => {
                spinner.classList.add('d-none');
            });
            document.querySelectorAll('#metricsCards .card').forEach(card => {
                card.classList.remove('loading');
                card.classList.add('pulse');
                setTimeout(() => card.classList.remove('pulse'), 1000);
            });
        }

        // Fetch and update metrics via AJAX
        async function updateMetrics() {
            try {
                const response = await fetch('/Dashboard/GetMetrics');
                if (!response.ok) throw new Error('Failed to fetch metrics');
                
                const metrics = await response.json();
                
                // Update metric cards with animation
                document.querySelector('.col-md-3:nth-child(1) .display-4').textContent = metrics.totalExecutions;
                document.querySelector('.col-md-3:nth-child(2) .display-4').textContent = metrics.successfulExecutions;
                document.querySelector('.col-md-3:nth-child(2) .card-text').textContent = `${metrics.successRate}% success rate`;
                document.querySelector('.col-md-3:nth-child(3) .display-4').textContent = metrics.failedExecutions;
                document.querySelector('.col-md-3:nth-child(4) .display-4').textContent = `${metrics.avgDuration} s`;
                
                // Update success chart
                successChart.data.datasets[0].data = [metrics.successfulExecutions, metrics.failedExecutions];
                successChart.update();
                
                console.log('‚úÖ Metrics updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating metrics:', error);
            }
        }

        // Fetch and update trends via AJAX
        async function updateTrends() {
            try {
                const response = await fetch('/Dashboard/GetTrends');
                if (!response.ok) throw new Error('Failed to fetch trends');
                
                const trends = await response.json();
                
                // Update trends chart
                trendsChart.data.labels = trends.map(t => t.date);
                trendsChart.data.datasets[0].data = trends.map(t => t.success);
                trendsChart.data.datasets[1].data = trends.map(t => t.failed);
                trendsChart.update();
                
                console.log('‚úÖ Trends updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating trends:', error);
            }
        }

        // Fetch and update last executed packages via AJAX
        async function updateLastExecutedPackages() {
            try {
                const response = await fetch('/Dashboard/GetLastExecutedPackages');
                if (!response.ok) throw new Error('Failed to fetch last executed packages');
                
                const packages = await response.json();
                
                // Update the table body
                const tbody = document.querySelector('#lastExecutedPackagesTable tbody');
                tbody.innerHTML = '';
                
                packages.forEach(pkg => {
                    const statusBadge = getStatusBadgeHTML(pkg.status);
                    const endTime = pkg.endTime ? new Date(pkg.endTime).toLocaleString('sv-SE').replace('T', ' ') : '-';
                    const duration = pkg.duration > 0 ? formatDuration(pkg.duration) : '-';
                    const startTime = new Date(pkg.startTime).toLocaleString('sv-SE').replace('T', ' ');
                    
                    const row = `
                        <tr>
                            <td><span class="badge bg-secondary">${pkg.executionId}</span></td>
                            <td><strong>${pkg.packageName}</strong></td>
                            <td>${pkg.folderName}</td>
                            <td>${pkg.projectName}</td>
                            <td>${statusBadge}</td>
                            <td>${startTime}</td>
                            <td>${endTime}</td>
                            <td>${duration}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                console.log('‚úÖ Last executed packages updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating last executed packages:', error);
            }
        }

        // Helper function to generate status badge HTML
        function getStatusBadgeHTML(status) {
            if (status === 'Succeeded') {
                return '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Succeeded</span>';
            } else if (status === 'Failed') {
                return '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Failed</span>';
            } else if (status === 'Running') {
                return '<span class="badge bg-primary"><i class="bi bi-arrow-clockwise"></i> Running</span>';
            } else if (status === 'Pending') {
                return '<span class="badge bg-warning"><i class="bi bi-hourglass"></i> Pending</span>';
            } else {
                return `<span class="badge bg-secondary">${status}</span>`;
            }
        }

        // Helper function to format duration
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Update all dashboard data
        async function refreshDashboard() {
            console.log('üîÑ Refreshing dashboard data...');
            showLoading();
            
            await Promise.all([
                updateMetrics(),
                updateTrends(),
                updateLastExecutedPackages()
            ]);
            
            hideLoading();
            
            // Update last refresh time
            const now = new Date().toLocaleTimeString();
            console.log(`‚ú® Dashboard refreshed at ${now}`);
        }

        // Start auto-refresh
        function startAutoRefresh() {
            console.log(`üöÄ Auto-refresh enabled (every ${REFRESH_INTERVAL / 1000} seconds)`);
            autoRefreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                console.log('‚è∏Ô∏è Auto-refresh paused');
            }
        }

        // Manual refresh button handler
        function manualRefresh() {
            stopAutoRefresh();
            refreshDashboard().then(() => {
                startAutoRefresh();
            });
        }

        // SignalR Connection
        let connection;
        
        function setupSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/dashboardHub")
                .withAutomaticReconnect()
                .build();

            // Handle metrics updates from server
            connection.on("ReceiveMetricsUpdate", function(metrics) {
                console.log('üì° Received metrics update via SignalR');
                // Update UI with pushed data
                document.querySelector('.col-md-3:nth-child(1) .display-4').textContent = metrics.totalExecutions;
                document.querySelector('.col-md-3:nth-child(2) .display-4').textContent = metrics.successfulExecutions;
                document.querySelector('.col-md-3:nth-child(2) .card-text').textContent = `${metrics.successRate}% success rate`;
                document.querySelector('.col-md-3:nth-child(3) .display-4').textContent = metrics.failedExecutions;
                document.querySelector('.col-md-3:nth-child(4) .display-4').textContent = `${metrics.avgDuration} s`;
            });

            // Handle trends updates from server
            connection.on("ReceiveTrendsUpdate", function(trends) {
                console.log('üì° Received trends update via SignalR');
                trendsChart.data.labels = trends.map(t => t.date);
                trendsChart.data.datasets[0].data = trends.map(t => t.success);
                trendsChart.data.datasets[1].data = trends.map(t => t.failed);
                trendsChart.update();
            });

            // Handle last executed packages updates from server
            connection.on("ReceiveLastExecutedPackagesUpdate", function(packages) {
                console.log('üì° Received last executed packages update via SignalR');
                const tbody = document.querySelector('#lastExecutedPackagesTable tbody');
                tbody.innerHTML = '';
                
                packages.forEach(pkg => {
                    const statusBadge = getStatusBadgeHTML(pkg.status);
                    const endTime = pkg.endTime ? new Date(pkg.endTime).toLocaleString('sv-SE').replace('T', ' ') : '-';
                    const duration = pkg.duration > 0 ? formatDuration(pkg.duration) : '-';
                    const startTime = new Date(pkg.startTime).toLocaleString('sv-SE').replace('T', ' ');
                    
                    const row = `
                        <tr>
                            <td><span class="badge bg-secondary">${pkg.executionId}</span></td>
                            <td><strong>${pkg.packageName}</strong></td>
                            <td>${pkg.folderName}</td>
                            <td>${pkg.projectName}</td>
                            <td>${statusBadge}</td>
                            <td>${startTime}</td>
                            <td>${endTime}</td>
                            <td>${duration}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });

            // Handle connection events
            connection.on("Connected", function(connectionId) {
                console.log(`‚úÖ SignalR Connected: ${connectionId}`);
                document.getElementById('autoRefreshStatus').innerHTML = 
                    '<i class="bi bi-broadcast"></i> Live Updates: ON';
            });

            connection.on("DataRefreshed", function() {
                console.log('üîî Server notified: Data refreshed');
                refreshDashboard();
            });

            connection.onreconnecting(() => {
                console.log('üîÑ SignalR reconnecting...');
                document.getElementById('autoRefreshStatus').classList.replace('bg-success', 'bg-warning');
            });

            connection.onreconnected(() => {
                console.log('‚úÖ SignalR reconnected');
                document.getElementById('autoRefreshStatus').classList.replace('bg-warning', 'bg-success');
            });

            connection.onclose(() => {
                console.log('‚ùå SignalR disconnected');
                document.getElementById('autoRefreshStatus').innerHTML = 'Auto-refresh: ON';
                document.getElementById('autoRefreshStatus').classList.replace('bg-success', 'bg-secondary');
            });

            // Start connection
            connection.start()
                .then(() => console.log('üöÄ SignalR connection established'))
                .catch(err => {
                    console.error('‚ùå SignalR connection failed:', err);
                    console.log('‚ö†Ô∏è Falling back to polling mode');
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            startAutoRefresh();
            setupSignalR();
            
            // Add visual feedback
            console.log('üìä SSIS Analytics Dashboard initialized');
            console.log(`‚è∞ Auto-refresh: Every ${REFRESH_INTERVAL / 1000} seconds`);
            console.log('üì° SignalR: Real-time updates enabled');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
            if (connection) {
                connection.stop();
            }
        });

        // Filter functionality
        function applyFilters() {
            const businessUnit = document.getElementById('businessUnitFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('packageSearch').value.toLowerCase();
            
            // Reload page with businessUnit filter if selected
            if (businessUnit) {
                window.location.href = `?businessUnit=${encodeURIComponent(businessUnit)}`;
                return;
            }
            
            // Client-side filtering for status and search
            // Filter Recent Executions
            filterTable('recentExecutionsTable', statusFilter, searchTerm, 1, 3);
            
            // Filter Last Executed Packages
            filterTable('lastExecutedPackagesTable', statusFilter, searchTerm, 1, 4);
            
            console.log('‚úÖ Filters applied');
        }

        function filterTable(tableId, status, searchTerm, packageNameCol, statusCol) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 0 || cells[0].getAttribute('colspan')) continue;
                
                const packageName = cells[packageNameCol].textContent.toLowerCase();
                const rowStatus = cells[statusCol].textContent.trim();
                
                let showRow = true;
                
                // Status filter
                if (status && !rowStatus.includes(status)) {
                    showRow = false;
                }
                
                // Search filter
                if (searchTerm && !packageName.includes(searchTerm)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            }
            
            console.log(`${tableId}: ${visibleCount} rows visible`);
        }

        // Export to CSV functionality
        function exportToCSV() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            const timestamp = new Date().toISOString().slice(0, 10);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Export Metrics
            csvContent += "SSIS Analytics Export - " + timestamp + "\n\n";
            csvContent += "Metrics Summary\n";
            csvContent += "Metric,Value\n";
            csvContent += `Total Executions,@Model.Metrics.TotalExecutions\n`;
            csvContent += `Successful Executions,@Model.Metrics.SuccessfulExecutions\n`;
            csvContent += `Failed Executions,@Model.Metrics.FailedExecutions\n`;
            csvContent += `Success Rate,@Model.Metrics.SuccessRate%\n`;
            csvContent += `Average Duration,@Model.Metrics.AvgDuration seconds\n\n`;
            
            // Export Last Executed Packages
            csvContent += "Last 10 Executed Packages\n";
            csvContent += "Execution ID,Package Name,Folder,Project,Status,Start Time,End Time,Duration (seconds)\n";
            
            @foreach (var pkg in Model.LastExecutedPackages)
            {
                var endTime = pkg.EndTime.HasValue ? pkg.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss") : "N/A";
                <text>
                csvContent += `@pkg.ExecutionId,"@pkg.PackageName","@pkg.FolderName","@pkg.ProjectName","@pkg.Status","@pkg.StartTime.ToString("yyyy-MM-dd HH:mm:ss")","@endTime",@pkg.Duration\n`;
                </text>
            }
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `SSIS_Analytics_${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ Data exported to CSV');
        }
    </script>
}
